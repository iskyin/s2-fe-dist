<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
    <meta content="width=device-width,initial-scale=1,user-scalable=no" name="viewport" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-touch-fullscreen" content="yes" />
    <meta name="format-detection" content="telephone=no,address=no" />
    <meta name="apple-mobile-web-app-status-bar-style" content="white" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>腾讯驿行</title>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    <script src="https://cdn.staticfile.org/jquery/3.4.0/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/vConsole/3.3.4/vconsole.min.js"></script>
  </head>
  <body>

    <script>
      // init vConsole
      var vConsole = new VConsole();
      
      // var hostApi='https://test-api-yixing.tencent.com/yixing/webapi/v1';
      var hostApi='http://10.98.213.45:18081/yixing/webapi/v1';

      // 获取url中的参数
      function getQueryVariable(variable){
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i=0;i<vars.length;i++) {
                var pair = vars[i].split("=");
                if(pair[0] == variable){return pair[1];}
        }
        return(false);
      }

      // 打开微信发票
      function getWechatConfig(accToken) {
        console.log(">>>>>>>>>> getWechatConfig <<<<<<<<<<<")
        console.log(" getWechatConfig >>>>>>>>>> accToken : ",accToken)
        accToken="eyJhbGciOiJIUzI1NiJ9.eyJzaWduIjoiTE9DQUxfWWlYaW5nMl9Ub2tlbl9FU01URVNUX3ZfbWxpYW5nc3VuIiwiZXhwIjoxNTk2NTM4NDU3LCJpYXQiOjE1OTY1MzA2OTc2ODR9.XlLXGpU1OvQFbtPK8VYO8PyNuu_TZzE3Lc3g11Ufft0"
        var url=window.location.origin+"/"
        var params = {'url':url};
        console.log(">>>>>>>>>> params : ",params)
        // 获取微信相关配置
        $.ajax({
          contentType: "application/json;charset=UTF-8",
          url: hostApi+'/wechat/getAuthVerifyConfig',
          type: "POST",
          dataType: "json",
          beforeSend: function(xhr) {
            xhr.setRequestHeader("Content-token",accToken);
          },
          data: JSON.stringify(params),
          async: true,
          success: function (res) {
              console.log("getAuthVerifyConfig >>>>>>>>> res: ",res)

              var wechatConfig={
                    debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                    //appId: res.data.appId, // 必填，公众号的唯一标识
                    //timestamp: res.data.timeStamp, // 必填，生成签名的时间戳
                    //nonceStr: res.data.nonceStr, // 必填，生成签名的随机串
                    //signature: res.data.signature,// 必填，签名，见附录1
                    appId: "wx539f7f60167e0d0b", // 必填，公众号的唯一标识
                    timestamp: "1596535459", // 必填，生成签名的时间戳
                    nonceStr: "123", // 必填，生成签名的随机串
                    signature: "8de265b2ba5bc8e1c5546fd2f62ad46282c9cc4a",// 必填，签名，见附录1
                    jsApiList: [
                      'getLocation'
                    ] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
                  }
              console.log("getAuthVerifyConfig >>>>>>>>> wechatConfig: ",wechatConfig)

              if (res.code==2000) {  //获取签名成功
                  window.wx.config(wechatConfig)
                  window.wx.ready(function () {
                    console.log('>>>>>>>>> ready <<<<<<<<< ')
                    window.wx.checkJsApi({
                      jsApiList: ['getLocation'], // 需要检测的JS接口列表，所有JS接口列表见附录2,
                      success: function (res) {
                        console.log('>>>>>>>>> checkJsApi <<<<<<<<< ')
                        console.log('checkJsApi >>>>>: ' + res)
                        if (res.errMsg.indexOf('ok') == -1) {
                          console.log(">>>>>>>>>> 失败 <<<<<<<<<<")
                          return;
                        }
                        // 微信发票
                        // wx.invoke(
                        //   'chooseInvoice',
                        //   {
                        //     timestamp: res.data.timestamp, //卡券签名时间戳
                        //     nonceStr: res.data.nonceStr, //卡券签名随机串
                        //     signType: 'SHA1', //签名方式，默认'SHA1'
                        //     cardSign: res.data.cardSign, //卡券签名
                        //   },
                        //   function (res) {
                        //     console.log(">>>>>>>>> invoke <<<<<<<<<<< ")
                        //         
                        //   }
                        // )

                      },
                    })
                  })
                  window.wx.error(function (err) {
                      console.log("初始化验证失败" + JSON.stringify(err));
                  });
 
              }else{
                console.log(">>>>>>>>> 请求失败 <<<<<<<<<<< ")
              }
          }

        });
      }


      // 获取token
      function getToken(){
        // ?time=1596180596840&ticket=6cfc4d1409dd4d4bbadf81bf51dee7b5
        console.log("getToken >>>>>>>>> ",getQueryVariable("ticket"))
        if(getQueryVariable("ticket")){
          var params = {
            "ticket":getQueryVariable("ticket")
          };
          $.ajax({
            contentType: "application/json;charset=UTF-8",
            url: hostApi+'/common/getTokenFromTicket',
            type: "POST",
            dataType: "json",
            data:  JSON.stringify(params),
            async: true,
            success: function (res) {
              console.log("getTokenFromTicket >>>>>>>>>>>>> ",res)
              if(res.code==2000){
                
              }else{
                alert(res.msg)
              }
            },
            complete: function (xhr) {
              console.log("xhr >>>>>>>>>>>>> ",xhr)
              // 获得所有字段的key
              var headers = xhr.getAllResponseHeaders();
              // 获得指定的字段
              var accToken = xhr.getResponseHeader("access-token");
              console.log("accToken >>>>>>>>>> ",accToken);
              if(accToken){
                getWechatConfig(accToken)
              }
            }
          });
        }else{
          alert("请求链接异常")
        }
      }

      // 页面初始化
      function pageInit(){
          // getToken();
          getWechatConfig('--------');
      }
      pageInit();




    </script>
  </body>
</html>
